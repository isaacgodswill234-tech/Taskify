
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Prime Protocol - Mini</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-color: #080a11;
            --card-bg: #121725;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #bef264;
            --accent-dark: #a3e635;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            overflow-x: hidden;
            font-size: 11px;
            user-select: none;
            -webkit-user-select: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .header-blur {
            background: rgba(8, 10, 17, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-pill {
            background: rgba(18, 23, 37, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .btn-fintech {
            background: var(--accent);
            color: #000000;
            font-weight: 700;
            border-radius: 10px;
            padding: 8px;
            text-transform: uppercase;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            transition: transform 0.1s;
        }

        .btn-fintech:active { transform: scale(0.97); }

        .status-chip {
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 7px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-pending { background: rgba(234, 179, 8, 0.1); color: #eab308; }
        .status-approved { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .status-rejected { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        .input-fintech {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            padding: 8px 10px;
            color: white;
            outline: none;
            width: 100%;
            font-size: 10px;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade { animation: fadeInUp 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCpjvqewcoUF4YztK0YtmFhrI7e4H1-HOg",
            authDomain: "first-but.firebaseapp.com",
            databaseURL: "https://first-but-default-rtdb.firebaseio.com",
            projectId: "first-but",
            storageBucket: "first-but.firebasestorage.app",
            messagingSenderId: "114535930457",
            appId: "1:114535930457:web:3260229c6910745864af48",
            measurementId: "G-LEH92CTB2M"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const tg = window.Telegram?.WebApp;
        const haptic = {
            impact: (s = 'medium') => tg?.HapticFeedback?.impactOccurred(s),
            notify: (t = 'success') => tg?.HapticFeedback?.notificationOccurred(t),
            selection: () => tg?.HapticFeedback?.selectionChanged()
        };

        const safeFormat = (val) => {
            const n = Number(val);
            return isNaN(n) ? "0" : n.toLocaleString();
        };

        const showToast = (msg, icon = "‚ö°") => {
            const container = document.getElementById('toast-container');
            if(!container) return;
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 w-[85%] bg-slate-900 border border-white/10 p-2.5 rounded-lg flex items-center gap-2 shadow-2xl z-[9999] animate-fade';
            toast.innerHTML = `<span class="text-sm">${icon}</span> <span class="text-[10px] font-bold">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = '0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        const TaskCard = ({ task, user, isPending, isCompleted, currency }) => {
            const [expanded, setExpanded] = useState(false);
            const [proof, setProof] = useState('');
            const [loading, setLoading] = useState(false);

            const submit = async () => {
                if (!proof) return showToast("Full screenshot required", "üì∑");
                if (isPending || isCompleted) return showToast("Submission already exists", "üö´");
                
                setLoading(true);
                try {
                    const ref = db.ref('submissions').push();
                    await ref.set({ id: ref.key, uid: user.uid, username: user.username, taskId: task.id, taskTitle: task.title, reward: task.reward, proof, status: 'pending', timestamp: Date.now() });
                    showToast("Signal Transmitted", "üöÄ");
                    setExpanded(false);
                    haptic.notify('success');
                } catch(e) { showToast("Sync Error", "‚ùå"); } finally { setLoading(false); }
            };

            const isDisabled = isPending || isCompleted;

            return (
                <div className={`card overflow-hidden ${isDisabled ? 'opacity-40 border-white/5' : 'border-white/10'}`}>
                    <div onClick={() => !isDisabled && setExpanded(!expanded)} className="p-2.5 flex items-center justify-between">
                        <div className="flex items-center gap-2.5">
                            <div className="w-9 h-9 rounded-lg bg-white/5 flex items-center justify-center text-lg">{task.icon || 'üéØ'}</div>
                            <div>
                                <h4 className="text-[10px] font-bold uppercase leading-tight">{task.title}</h4>
                                <div className="flex items-center gap-1.5 mt-0.5">
                                    <span className="text-[9px] font-black text-[var(--accent)]">+{task.reward} {currency}</span>
                                    {isPending && <span className="status-chip status-pending">In Review</span>}
                                    {isCompleted && <span className="status-chip status-approved">Verified</span>}
                                </div>
                            </div>
                        </div>
                        {!isDisabled && <span className="text-slate-600 text-[8px]">{expanded ? '‚ñ≤' : '‚ñº'}</span>}
                    </div>
                    {expanded && !isDisabled && (
                        <div className="px-2.5 pb-2.5 space-y-2 pt-2 border-t border-white/5 animate-fade">
                            <p className="text-[9px] text-slate-400 leading-relaxed">{task.description}</p>
                            {task.link && <button onClick={() => window.open(task.link, '_blank')} className="w-full py-2 bg-white/5 rounded-lg text-[9px] font-bold border border-white/5 uppercase">EXECUTE TASK</button>}
                            <div className="relative h-24 bg-black/30 rounded-lg border border-dashed border-white/10 flex flex-col items-center justify-center overflow-hidden">
                                <input type="file" accept="image/*" onChange={e => {
                                    if (!e.target.files[0]) return;
                                    const r = new FileReader();
                                    r.onload = (ev) => setProof(ev.target.result);
                                    r.readAsDataURL(e.target.files[0]);
                                }} className="absolute inset-0 opacity-0 z-10" />
                                {proof ? <img src={proof} className="w-full h-full object-cover" /> : 
                                    <div className="text-center opacity-40">
                                        <div className="text-2xl mb-1">üì∏</div>
                                                <div className="text-[7px] font-bold uppercase tracking-widest">Upload Full Screenshot</div>
                                    </div>
                                }
                            </div>
                            <button disabled={loading || !proof} onClick={submit} className="btn-fintech">{loading ? 'TRANSMITTING...' : 'SUBMIT FULL SCREENSHOT'}</button>
                        </div>
                    )}
                </div>
            );
        };

        const AdminPanel = ({ onExit, tasks, appConfig }) => {
            const [view, setView] = useState('subs');
            const [subs, setSubs] = useState([]);
            const [withdrawals, setWithdrawals] = useState([]);
            const [taskForm, setTaskForm] = useState({ id: '', title: '', description: '', reward: 1000, icon: 'üéØ', link: '' });
            const [settings, setSettings] = useState({ ...appConfig });

            useEffect(() => {
                const sRef = db.ref('submissions');
                sRef.on('value', s => setSubs(s.exists() ? Object.values(s.val()) : []));
                const wRef = db.ref('withdrawals');
                wRef.on('value', s => setWithdrawals(s.exists() ? Object.values(s.val()) : []));
                return () => { sRef.off(); wRef.off(); };
            }, []);

            const updateSettings = (key, val) => setSettings(prev => ({ ...prev, [key]: val }));

            return (
                <div className="fixed inset-0 bg-[#080a11] p-4 overflow-y-auto z-[9999] no-scrollbar pb-24">
                    <div className="flex justify-between items-center mb-5">
                        <h2 className="text-xs font-black uppercase tracking-widest">Protocol Admin</h2>
                        <button onClick={onExit} className="bg-white/5 w-8 h-8 rounded-full border border-white/5">√ó</button>
                    </div>
                    <div className="flex gap-2 mb-5 overflow-x-auto no-scrollbar">
                        {['subs', 'payouts', 'tasks', 'config'].map(v => (
                            <button key={v} onClick={() => setView(v)} className={`px-3 py-2 rounded-lg text-[9px] font-bold uppercase border shrink-0 ${view === v ? 'bg-[var(--accent)] border-transparent text-black' : 'bg-white/5 border-white/5 text-slate-500'}`}>{v}</button>
                        ))}
                    </div>

                    {view === 'subs' && (
                        <div className="space-y-3">
                            {subs.filter(s => s.status === 'pending').map(s => (
                                <div key={s.id} className="card p-3 space-y-2">
                                    <div className="flex justify-between text-[9px] font-bold"><span className="text-[var(--accent)]">@{s.username}</span><span>{s.taskTitle}</span></div>
                                    <img src={s.proof} className="w-full h-auto max-h-80 object-contain rounded-lg border border-white/5 bg-black" />
                                    <div className="flex gap-2">
                                        <button onClick={() => {
                                            db.ref(`users/${s.uid}`).transaction(u => { if(u) u.points = (u.points || 0) + Number(s.reward); return u; });
                                            db.ref(`submissions/${s.id}/status`).set('approved');
                                            showToast("Mission Approved", "‚úÖ");
                                        }} className="flex-1 bg-green-500 py-2 rounded-lg text-black font-bold text-[9px] uppercase">APPROVE</button>
                                        <button onClick={() => { 
                                            db.ref(`submissions/${s.id}/status`).set('rejected'); 
                                            showToast("Mission Rejected", "‚ùå"); 
                                        }} className="flex-1 bg-white/5 py-2 rounded-lg text-slate-500 font-bold text-[9px] border border-white/5 uppercase">DENY</button>
                                    </div>
                                </div>
                            ))}
                            {subs.filter(s => s.status === 'pending').length === 0 && <p className="text-center py-10 opacity-20 text-[10px] uppercase">All signals processed</p>}
                        </div>
                    )}

                    {view === 'payouts' && (
                        <div className="space-y-3">
                            {withdrawals.filter(w => w.status === 'pending').map(w => (
                                <div key={w.id} className="card p-3 space-y-2">
                                    <div className="flex justify-between font-bold text-[10px]"><span>@{w.username}</span><span className="text-[var(--accent)]">{safeFormat(w.amount)} {w.currency}</span></div>
                                    <div className="bg-black/40 p-2 rounded-lg text-[9px] font-mono border border-white/5 space-y-1">
                                        <div>BANK: {w.bankName}</div>
                                        <div>ACC: <span className="select-all text-[var(--accent)] font-bold">{w.accountNumber}</span></div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { 
                                            db.ref(`withdrawals/${w.id}/status`).set('approved'); 
                                            showToast("Paid", "üí∏"); 
                                        }} className="flex-1 btn-fintech uppercase py-2">MARK PAID</button>
                                        <button onClick={() => {
                                            db.ref(`users/${w.uid}/points`).transaction(p => (p || 0) + Number(w.amount));
                                            db.ref(`withdrawals/${w.id}/status`).set('rejected');
                                            showToast("Refunded", "‚ùå");
                                        }} className="flex-1 bg-white/5 rounded-lg text-slate-500 text-[9px] font-bold border border-white/5 uppercase">REJECT</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {view === 'tasks' && (
                        <div className="space-y-4">
                            <div className="card p-3 space-y-2">
                                <h3 className="text-[9px] font-bold text-slate-500 uppercase">Deploy Mission</h3>
                                <input value={taskForm.title} onChange={e => setTaskForm({...taskForm, title: e.target.value})} className="input-fintech" placeholder="Title" />
                                <textarea value={taskForm.description} onChange={e => setTaskForm({...taskForm, description: e.target.value})} className="input-fintech" placeholder="Instructions" rows="2" />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="number" value={taskForm.reward} onChange={e => setTaskForm({...taskForm, reward: Number(e.target.value)})} className="input-fintech" placeholder="Reward" />
                                    <input value={taskForm.icon} onChange={e => setTaskForm({...taskForm, icon: e.target.value})} className="input-fintech" placeholder="Emoji" />
                                </div>
                                <input value={taskForm.link} onChange={e => setTaskForm({...taskForm, link: e.target.value})} className="input-fintech" placeholder="Task Link" />
                                <button onClick={() => {
                                    if(!taskForm.title) return;
                                    const id = taskForm.id || db.ref('tasks').push().key;
                                    db.ref(`tasks/${id}`).set({...taskForm, id});
                                    setTaskForm({id:'', title:'', description:'', reward: 1000, icon:'üéØ', link:''});
                                    showToast("Mission Saved", "üöÄ");
                                }} className="btn-fintech py-2.5">SAVE MISSION</button>
                            </div>
                            <div className="space-y-2">
                                {tasks.map(t => (
                                    <div key={t.id} className="card p-2 flex justify-between items-center border-white/5 bg-white/[0.01]">
                                        <span className="text-[9px] font-bold">{t.icon} {t.title}</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => setTaskForm(t)} className="text-[9px] font-bold text-slate-500">EDIT</button>
                                            <button onClick={() => { if(confirm("Delete Task?")) db.ref(`tasks/${t.id}`).remove(); }} className="text-rose-500 text-[9px] font-bold">DEL</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {view === 'config' && (
                        <div className="space-y-4">
                            <div className="card p-3 space-y-3">
                                <h3 className="text-[9px] font-bold text-slate-500 uppercase">Protocol Config</h3>
                                <div className="space-y-2">
                                    <label className="text-[8px] font-bold uppercase text-slate-600">Bot Settings</label>
                                    <input value={settings.botToken} onChange={e => updateSettings('botToken', e.target.value)} className="input-fintech mb-1" placeholder="Bot API Token" />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input value={settings.botUsername} onChange={e => updateSettings('botUsername', e.target.value)} className="input-fintech" placeholder="Bot Username" />
                                        <input value={settings.appShortName} onChange={e => updateSettings('appShortName', e.target.value)} className="input-fintech" placeholder="Bot Shortname (play)" />
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[8px] font-bold uppercase text-slate-600">App Core</label>
                                    <input value={settings.appName} onChange={e => updateSettings('appName', e.target.value)} className="input-fintech mb-1" placeholder="App Name" />
                                    <input value={settings.channel1} onChange={e => updateSettings('channel1', e.target.value)} className="input-fintech mb-1" placeholder="Channel 1" />
                                    <input value={settings.channel2} onChange={e => updateSettings('channel2', e.target.value)} className="input-fintech" placeholder="Channel 2" />
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="space-y-1">
                                        <label className="text-[8px] font-bold uppercase text-slate-600">Currency</label>
                                        <input value={settings.currency} onChange={e => updateSettings('currency', e.target.value)} className="input-fintech" />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[8px] font-bold uppercase text-slate-600">Min Pay</label>
                                        <input type="number" value={settings.minWithdrawal} onChange={e => updateSettings('minWithdrawal', Number(e.target.value))} className="input-fintech" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="space-y-1">
                                        <label className="text-[8px] font-bold uppercase text-slate-600">Ref Bonus</label>
                                        <input type="number" value={settings.referralReward} onChange={e => updateSettings('referralReward', Number(e.target.value))} className="input-fintech" />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[8px] font-bold uppercase text-slate-600">Admin PIN</label>
                                        <input value={settings.adminPin} onChange={e => updateSettings('adminPin', e.target.value)} className="input-fintech" maxLength={4} />
                                    </div>
                                </div>
                                <button onClick={() => { db.ref('config/app').set(settings); showToast("Global Protocol Updated", "‚öôÔ∏è"); }} className="btn-fintech py-3 mt-2">DEPLOY ALL UPDATES</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('earn');
            const [tasks, setTasks] = useState([]);
            const [userSubs, setUserSubs] = useState([]);
            const [userWithdrawals, setUserWithdrawals] = useState([]);
            const [leaderboard, setLeaderboard] = useState([]);
            const [lbSort, setLbSort] = useState('refs'); 
            const [config, setConfig] = useState({ 
                appName: 'Prime Protocol', 
                minWithdrawal: 1000, 
                referralReward: 500, 
                adminPin: '2025', 
                currency: '‚Ç¶', 
                botUsername: '', 
                appShortName: 'play', 
                channel1: '', 
                channel2: '', 
                channel3: '', 
                botToken: '' 
            });
            const [showAdmin, setShowAdmin] = useState(false);
            const [showPin, setShowPin] = useState(false);
            const [gatekeeper, setGatekeeper] = useState(false);
            const [clicks, setClicks] = useState(0);

            useEffect(() => {
                if(tg) { tg.ready(); tg.expand(); }
                const uid = tg?.initDataUnsafe?.user?.id?.toString() || localStorage.getItem('prime_uid') || 'u_'+Math.random().toString(36).substr(2, 9);
                localStorage.setItem('prime_uid', uid);

                // FASTER LOADING: Fetch config and specific user only
                    db.ref('config/app').on('value', s => s.exists() && setConfig(p => ({...p, ...s.val()})));
                db.ref('tasks').on('value', s => setTasks(s.exists() ? Object.values(s.val()) : []));
                
                const userRef = db.ref(`users/${uid}`);
                userRef.on('value', s => {
                    if(s.exists()) { 
                        setUser(s.val()); 
                        setGatekeeper(false); 
                    } else { 
                        setGatekeeper(true); 
                    }
                    setLoading(false); // UI shows up as soon as user is identified
                });

                db.ref('submissions').orderByChild('uid').equalTo(uid).on('value', s => {
                    setUserSubs(s.exists() ? Object.values(s.val()).reverse() : []);
                });

                db.ref('withdrawals').orderByChild('uid').equalTo(uid).on('value', s => {
                    setUserWithdrawals(s.exists() ? Object.values(s.val()).reverse() : []);
                });

                // PERFORMANCE: Limit leaderboard to top 50 only
                db.ref('users').orderByChild('referralCount').limitToLast(50).on('value', s => {
                    if(s.exists()) setLeaderboard(Object.values(s.val()));
                });
                
                return () => db.ref().off();
            }, []);

            const sortedLeaderboard = useMemo(() => {
                return [...leaderboard].sort((a, b) => {
                    if(lbSort === 'refs') {
                        if((b.referralCount || 0) === (a.referralCount || 0)) return (b.points || 0) - (a.points || 0);
                        return (b.referralCount || 0) - (a.referralCount || 0);
                    }
                    return (b.points || 0) - (a.points || 0);
                }).slice(0, 20);
            }, [leaderboard, lbSort]);

            const join = async () => {
                const uid = localStorage.getItem('prime_uid');
                const start = tg?.initDataUnsafe?.start_param;
                const newUser = { 
                    uid, 
                    username: tg?.initDataUnsafe?.user?.username || 'participant_'+uid.slice(-4), 
                    points: 0, 
                    referralCount: 0, 
                    timestamp: Date.now() 
                };
                
                if(start && start !== uid) {
                    newUser.referredBy = start;
                    db.ref(`users/${start}`).transaction(u => { 
                        if(u) { 
                            u.points = (u.points || 0) + (config.referralReward || 500); 
                            u.referralCount = (u.referralCount || 0) + 1; 
                        } 
                        return u; 
                    });
                }
                
                await db.ref(`users/${uid}`).set(newUser);
                setGatekeeper(false);
                showToast("Identity Synced", "üõ∞Ô∏è");
            };

            if(loading) return (
                <div className="fixed inset-0 flex flex-col items-center justify-center bg-[#080a11] text-white">
                    <div className="w-10 h-10 border-4 border-[var(--accent)] border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-[9px] font-bold uppercase tracking-[4px] opacity-40">Syncing Protocol...</p>
                </div>
            );

            if(gatekeeper) return (
                <div className="fixed inset-0 bg-[#080a11] p-6 flex flex-col items-center justify-center text-center animate-fade">
                    <div className="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center text-3xl mb-5 border border-white/5 shadow-2xl">üîí</div>
                    <h2 className="text-lg font-black mb-2 uppercase tracking-tight">Node Offline</h2>
                    <p className="text-[10px] text-slate-500 mb-8 uppercase tracking-widest leading-relaxed px-4">Initialize your node by joining our verified protocol communication channels.</p>
                    <div className="w-full space-y-2 mb-8">
                        {config.channel1 && <button onClick={() => window.open(config.channel1)} className="w-full py-3 bg-white/5 rounded-xl text-[10px] font-bold border border-white/5 uppercase">CHANNEL ALPHA</button>}
                        {config.channel2 && <button onClick={() => window.open(config.channel2)} className="w-full py-3 bg-white/5 rounded-xl text-[10px] font-bold border border-white/5 uppercase">CHANNEL BETA</button>}
                    </div>
                    <button onClick={join} className="btn-fintech py-4 text-xs">SYNCHRONIZE NODE</button>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 no-scrollbar">
                    {showAdmin && <AdminPanel onExit={() => setShowAdmin(false)} tasks={tasks} appConfig={config} />}
                    {showPin && (
                        <div className="fixed inset-0 bg-black/98 flex flex-col items-center justify-center z-[9999] backdrop-blur-xl">
                            <h2 className="text-[10px] font-bold uppercase text-[var(--accent)] mb-6 tracking-widest">Protocol Overload Access</h2>
                            <input type="password" maxLength={4} onChange={e => { if(e.target.value === config.adminPin) { setShowAdmin(true); setShowPin(false); haptic.notify('success'); } }} className="w-32 bg-transparent border-b-2 border-white/10 text-center text-3xl font-bold text-white outline-none tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autoFocus />
                            <button onClick={() => setShowPin(false)} className="mt-8 text-[9px] font-bold text-slate-600 uppercase tracking-widest">CANCEL OVERRIDE</button>
                        </div>
                    )}

                    <header className="px-5 py-4 flex justify-between items-center sticky top-0 z-50 header-blur">
                        <div className="flex items-center gap-2.5">
                            <div className="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center font-bold text-xs border border-white/5 uppercase shadow-inner">{user?.username ? user.username[0] : 'U'}</div>
                            <div>
                                <h1 className="text-[10px] font-bold tracking-tight">@{user?.username}</h1>
                                <p className="text-[7px] font-bold text-slate-500 uppercase tracking-widest">{config.appName} Protocol</p>
                            </div>
                        </div>
                        <div onClick={() => { setClicks(p=>p+1); if(clicks>=19){setClicks(0);setShowPin(true);} }} className="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-xs border border-white/5 active:scale-90 transition-transform">‚ö°</div>
                    </header>

                    <main className="p-4 space-y-6">
                        {activeTab === 'earn' && (
                            <div className="space-y-4 animate-fade">
                                <div className="bg-slate-900/60 rounded-[20px] p-6 text-center border border-white/5 relative overflow-hidden backdrop-blur-sm shadow-xl">
                                    <p className="text-[8px] font-bold text-slate-500 uppercase tracking-[3px] mb-1">Available Credits</p>
                                    <h2 className="text-3xl font-black italic tracking-tighter">{safeFormat(user?.points)} <span className="text-[10px] opacity-20 not-italic uppercase">{config.currency}</span></h2>
                                    <div className="flex gap-2 mt-5">
                                        <div className="flex-1 bg-white/5 py-2.5 rounded-lg text-[8px] font-bold uppercase border border-white/5">Verified: {userSubs.filter(s=>s.status==='approved').length}</div>
                                        <div className="flex-1 bg-white/5 py-2.5 rounded-lg text-[8px] font-bold uppercase border border-white/5">Recruits: {user?.referralCount || 0}</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => { setActiveTab('tasks'); haptic.selection(); }} className="card p-4 flex flex-col items-center gap-2 group border-white/10 hover:bg-white/5 transition-colors">
                                        <span className="text-2xl">üéØ</span>
                                        <span className="text-[8px] font-bold uppercase tracking-widest text-slate-400">Mission Hub</span>
                                    </button>
                                    <button onClick={() => { setActiveTab('frens'); haptic.selection(); }} className="card p-4 flex flex-col items-center gap-2 group border-white/10 hover:bg-white/5 transition-colors">
                                        <span className="text-2xl">ü§ù</span>
                                        <span className="text-[8px] font-bold uppercase tracking-widest text-slate-400">Recruitment</span>
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'tasks' && (
                            <div className="space-y-3 animate-fade">
                                <h3 className="text-[9px] font-bold uppercase text-slate-500 px-1 tracking-widest">Operational Tasks</h3>
                                {tasks.length === 0 ? <p className="text-center opacity-10 py-10 uppercase text-[9px] tracking-widest">Scanning Network...</p> : 
                                    tasks.map(t => {
                                        const sub = userSubs.find(s => s.taskId === t.id);
                                        return <TaskCard key={t.id} task={t} user={user} isPending={sub?.status === 'pending'} isCompleted={sub?.status === 'approved'} currency={config.currency} />;
                                    })
                                }
                            </div>
                        )}

                        {activeTab === 'ranks' && (
                            <div className="space-y-3 animate-fade pb-10">
                                <h3 className="text-center text-[10px] font-bold uppercase text-slate-500 mb-1 tracking-[4px]">Top Protocol Nodes</h3>
                                <div className="flex justify-center gap-2 mb-4">
                                    <button onClick={() => setLbSort('refs')} className={`px-4 py-1.5 rounded-lg text-[7px] font-bold uppercase tracking-widest border ${lbSort === 'refs' ? 'bg-[var(--accent)] text-black border-transparent' : 'bg-white/5 text-slate-600 border-white/5'}`}>Sort By Refs</button>
                                    <button onClick={() => setLbSort('balance')} className={`px-4 py-1.5 rounded-lg text-[7px] font-bold uppercase tracking-widest border ${lbSort === 'balance' ? 'bg-[var(--accent)] text-black border-transparent' : 'bg-white/5 text-slate-600 border-white/5'}`}>Sort By Points</button>
                                </div>
                                {sortedLeaderboard.map((u, i) => (
                                    <div key={i} className={`card p-3.5 flex justify-between items-center bg-white/[0.01] ${u.uid === user?.uid ? 'border-[var(--accent)] bg-[var(--accent)]/5' : 'border-white/5'}`}>
                                        <div className="flex items-center gap-3">
                                            <span className="text-[9px] font-black text-slate-800 w-4">#{i+1}</span>
                                            <div className="flex flex-col">
                                                <span className="text-[10px] font-bold truncate max-w-[100px]">@{u.username}</span>
                                                <span className="text-[7px] text-slate-600 uppercase font-bold">{u.referralCount || 0} RECRUITS SYNCED</span>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <span className="text-[10px] font-black text-[var(--accent)] italic">{safeFormat(u.points)}</span>
                                            <p className="text-[6px] text-slate-700 font-bold uppercase">{config.currency}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'frens' && (
                            <div className="text-center pt-8 animate-fade px-2">
                                <div className="w-16 h-16 bg-white/5 rounded-2xl mx-auto flex items-center justify-center text-3xl mb-4 border border-white/5 shadow-2xl">ü§ù</div>
                                <h3 className="text-xl font-black italic mb-2 tracking-tighter uppercase">Expand Network</h3>
                                <p className="text-[10px] text-slate-500 mb-8 uppercase leading-relaxed tracking-wider">Acquire <span className="text-[var(--accent)] font-bold">+{config.referralReward} {config.currency}</span> for every verified signal synced to your node.</p>
                                <button onClick={() => { 
                                    if(!config.botUsername) return showToast("Bot configuration missing", "‚ö†Ô∏è");
                                    const botLink = `https://t.me/${config.botUsername}/${config.appShortName}?startapp=${user?.uid}`;
                                    navigator.clipboard.writeText(botLink); 
                                    showToast("Protocol Link Copied", "üìã"); 
                                    haptic.impact('medium');
                                }} className="btn-fintech py-4 text-[10px] tracking-widest">GENERATE RECRUIT LINK</button>
                            </div>
                        )}

                        {activeTab === 'wallet' && (
                            <div className="space-y-6 animate-fade pb-12">
                                <div className="card p-5 text-center bg-slate-900/50 border-none shadow-inner">
                                    <p className="text-[8px] font-bold text-slate-500 uppercase tracking-widest mb-1">Capital Extraction</p>
                                    <h2 className="text-3xl font-black italic tracking-tighter">{safeFormat(user?.points)} <span className="text-xs opacity-20 not-italic">{config.currency}</span></h2>
                                </div>
                                <div className="card p-4 space-y-3">
                                    <h3 className="text-[9px] font-bold text-slate-500 uppercase px-1">Withdraw Assets</h3>
                                    <input type="number" id="wAmt" className="input-fintech" placeholder={`Min Extraction: ${config.minWithdrawal}`} />
                                    <input id="wBank" className="input-fintech" placeholder="Institution" />
                                    <input id="wAcc" className="input-fintech" placeholder="Account ID" maxLength={10} />
                                    <button onClick={async () => {
                                        const amt = Number(document.getElementById('wAmt').value);
                                        const b = document.getElementById('wBank').value;
                                        const a = document.getElementById('wAcc').value;
                                        if(amt < config.minWithdrawal) return showToast("Below Threshold", "‚ùå");
                                        if(amt > user.points) return showToast("Insufficient Credits", "‚ùå");
                                        if(!b || a.length < 10) return showToast("Invalid Data", "‚ùå");
                                        
                                        haptic.impact('heavy');
                                        const r = db.ref('withdrawals').push();
                                        await r.set({ uid: user.uid, username: user.username, amount: amt, bankName: b, accountNumber: a, status: 'pending', timestamp: Date.now(), currency: config.currency, id: r.key });
                                        await db.ref(`users/${user.uid}/points`).transaction(p => (p || 0) - amt);
                                        
                                        document.getElementById('wAmt').value = '';
                                        document.getElementById('wBank').value = '';
                                        document.getElementById('wAcc').value = '';
                                        showToast("Extraction Initialized", "üõ∞Ô∏è");
                                    }} className="btn-fintech py-4 text-[10px] tracking-widest">INITIALIZE EXTRACTION</button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="space-y-2">
                                        <h4 className="text-[8px] font-bold text-slate-500 uppercase tracking-widest px-1">Mission Log (Latest)</h4>
                                        {userSubs.length === 0 ? <p className="text-[7px] text-center py-4 opacity-20">No Missions Syncing</p> : 
                                            userSubs.slice(0, 5).map(s => (
                                                <div key={s.id} className="flex justify-between items-center bg-white/[0.02] p-2 rounded-lg border border-white/5">
                                                    <span className="text-[8px] font-bold uppercase truncate max-w-[150px]">{s.taskTitle}</span>
                                                    <span className={`status-chip status-${s.status}`}>{s.status}</span>
                                                </div>
                                            ))
                                        }
                                    </div>
                                    <div className="space-y-2">
                                        <h4 className="text-[8px] font-bold text-slate-500 uppercase tracking-widest px-1">Extraction Log (Latest)</h4>
                                        {userWithdrawals.length === 0 ? <p className="text-[7px] text-center py-4 opacity-20">No Extractions Recorded</p> : 
                                            userWithdrawals.slice(0, 5).map(w => (
                                                <div key={w.id} className="flex justify-between items-center bg-white/[0.02] p-2 rounded-lg border border-white/5">
                                                    <div className="flex flex-col">
                                                        <span className="text-[8px] font-bold uppercase">{safeFormat(w.amount)} {w.currency}</span>
                                                        <span className="text-[6px] text-slate-600">{w.bankName}</span>
                                                    </div>
                                                    <span className={`status-chip status-${w.status}`}>{w.status}</span>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-4 left-4 right-4 h-14 nav-pill rounded-[18px] flex items-center justify-around z-50 px-1 shadow-2xl">
                        {[
                            { id: 'earn', icon: 'üè†', label: 'HUB' },
                            
